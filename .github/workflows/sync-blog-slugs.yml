name: Sync Blog Filenames with Slugs

on:
  push:
    paths:
      - 'content/blog/*.mdx'
    branches:
      - main

jobs:
  sync-slugs:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 2

      - name: Check for duplicate slugs
        id: check_duplicates
        run: |
          cd content/blog

          # Extract all slugs and check for duplicates
          declare -A slug_files
          has_duplicate=false
          duplicate_info=""

          for file in *.mdx; do
            [ -f "$file" ] || continue

            slug=$(sed -n '/^---$/,/^---$/p' "$file" | grep -m1 "^slug:" | sed 's/^slug:[[:space:]]*//' | tr -d "\"'" | tr -d '[:space:]')

            if [ -n "$slug" ]; then
              if [ -n "${slug_files[$slug]}" ]; then
                has_duplicate=true
                duplicate_info="Slug '$slug' is used by both '${slug_files[$slug]}' and '$file'"
                echo "::error::DUPLICATE SLUG DETECTED: $duplicate_info"
              else
                slug_files[$slug]="$file"
              fi
            fi
          done

          echo "has_duplicate=$has_duplicate" >> $GITHUB_OUTPUT
          echo "duplicate_info=$duplicate_info" >> $GITHUB_OUTPUT

      - name: Revert commit if duplicate found
        if: steps.check_duplicates.outputs.has_duplicate == 'true'
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"

          echo "DUPLICATE SLUG DETECTED - Reverting commit..."
          echo "${{ steps.check_duplicates.outputs.duplicate_info }}"

          # Revert the last commit
          git revert --no-edit HEAD

          # Add explanation to commit message
          git commit --amend -m "REVERTED: Duplicate slug detected

${{ steps.check_duplicates.outputs.duplicate_info }}

Please use a unique slug for each blog post."

          git push

          echo "::error::Your change was reverted because it would create a duplicate URL. Please use a different slug."
          exit 1

      - name: Sync filenames with slugs
        if: steps.check_duplicates.outputs.has_duplicate != 'true'
        id: sync
        run: |
          cd content/blog
          renamed=false
          has_error=false

          # Initialize redirects.json if it doesn't exist
          if [ ! -f "redirects.json" ]; then
            echo "{}" > redirects.json
          fi

          for file in *.mdx; do
            [ -f "$file" ] || continue

            # Extract slug from frontmatter (handles both quoted and unquoted)
            slug=$(sed -n '/^---$/,/^---$/p' "$file" | grep -m1 "^slug:" | sed 's/^slug:[[:space:]]*//' | tr -d "\"'" | tr -d '[:space:]')

            if [ -n "$slug" ]; then
              filename="${file%.mdx}"

              if [ "$filename" != "$slug" ]; then
                target_file="${slug}.mdx"

                # Check if target file already exists (duplicate slug error)
                if [ -f "$target_file" ]; then
                  has_error=true
                  echo "::error::Cannot rename '$file' to '$target_file' - a file with slug '$slug' already exists!"
                else
                  echo "Renaming: $file -> $target_file"
                  echo "Adding redirect: $filename -> $slug"

                  # Update redirects.json using jq
                  jq --arg old "$filename" --arg new "$slug" '
                    .[$old] = $new |
                    to_entries |
                    map(if .value == $old then .value = $new else . end) |
                    from_entries
                  ' redirects.json > redirects.tmp && mv redirects.tmp redirects.json

                  git mv "$file" "$target_file"
                  renamed=true
                fi
              fi
            fi
          done

          if [ "$has_error" = true ]; then
            echo "Please use a different slug - another blog post already uses this URL."
            exit 1
          fi

          echo "renamed=$renamed" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.check_duplicates.outputs.has_duplicate != 'true' && steps.sync.outputs.renamed == 'true'
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add -A content/blog/
          git commit -m "Auto-rename blog files to match custom slugs"
          git push
